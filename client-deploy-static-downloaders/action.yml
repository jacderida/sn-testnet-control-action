name: Client Deploy Static Downloaders
description: Deploys a new client environment consisting of static downloaders
inputs:
  ansible-forks:
    description: Override the maximum number of forks Ansible will use to execute tasks on target hosts
  ansible-verbose:
    description: Set to use verbose output for Ansible
    default: false
  ant-version:
    description: Supply a version for ant. Otherwise the latest will be used.
  branch:
    description: >
      Build binaries from the specified autonomi branch. The testnet will use these binaries.
  chunk-size:
    description: >
      Specify the chunk size in bytes as a 64-bit integer.
      Only applies when building a custom branch.
  client-env:
    description: Pass a comma-separated list of environment variables to the ant binary
  client-vm-count:
    description: Number of client VMs to be deployed
  client-vm-size:
    description: The size of the Client VMs
  delayed-verifier-batch-size:
    description: The batch size for the delayed verifier downloader
  delayed-verifier-quorum-value:
    description: The quorum value for the delayed verifier downloader
  disable-delayed-verifier:
    description: Set to disable the delayed-verifier downloader on the VMs
    default: false
  disable-performance-verifier:
    description: Set to disable the performance-verifier downloader on the VMs
    default: false
  disable-random-verifier:
    description: Set to disable the random-verifier downloader on the VMs
    default: false
  disable-telegraf:
    description: Disable Telegraf metrics collection if set to true
    default: false
  environment-type:
    description: >
      Possible values are 'development', 'staging' and 'production'. This value determines the sizes
      and counts of VMs. The counts can be overridden with the other count inputs.
    required: true
    default: development
  evm-data-payments-address:
    description: The address of the EVM data payments contract
  evm-network-type:
    description: >
      The type of EVM network to use. Possible values are 'arbitrum-one' or 'custom'.
    default: 'arbitrum-one'
  evm-payment-token-address:
    description: The address of the EVM payment token contract
  evm-rpc-url:
    description: The RPC URL for the EVM network when using a custom network type
  file-address:
    description: The address of a specific file to download
  name:
    description: The name of the environment
    required: true
  network-id:
    description: >
      Specify the network ID to use for the node services. This is used to partition the network
      and will not allow nodes with different network IDs to join.
    required: true
  network-contacts-url:
    description: The networks contacts URL from an existing network
  peer:
    description: A peer from an existing network that the Ant client can connect to (in multiaddr format)
  performance-verifier-batch-size:
    description: The batch size for the performance verifier downloader
  provider:
    description: The cloud provider. Accepts 'aws' or 'digital-ocean'.
    required: true
    default: digital-ocean
  random-verifier-batch-size:
    description: The batch size for the random verifier downloader
  region:
    description: The cloud region to deploy resources in. Defaults to "lon1" for Digital Ocean.
    default: lon1
  repo-owner:
    description: >
      Build binaries from the autonomi repository owned by this org or username. The testnet
      will use these binaries.
  skip-binary-build:
    description: >
      Skip building the autonomi binaries if they were built during a previous run of the deployer
      using the same branch, repo-owner and name arguments.
    default: false
  sleep-duration:
    description: Duration to sleep in seconds between downloader operations

runs:
  using: composite
  steps:
    - name: Deploy static downloaders
      env:
        ANSIBLE_FORKS: ${{ inputs.ansible-forks }}
        ANSIBLE_VERBOSE: ${{ inputs.ansible-verbose }}
        ANT_VERSION: ${{ inputs.ant-version }}
        BRANCH: ${{ inputs.branch }}
        CHUNK_SIZE: ${{ inputs.chunk-size }}
        CLIENT_ENV: ${{ inputs.client-env }}
        CLIENT_VM_COUNT: ${{ inputs.client-vm-count }}
        CLIENT_VM_SIZE: ${{ inputs.client-vm-size }}
        DELAYED_VERIFIER_BATCH_SIZE: ${{ inputs.delayed-verifier-batch-size }}
        DELAYED_VERIFIER_QUORUM_VALUE: ${{ inputs.delayed-verifier-quorum-value }}
        DISABLE_DELAYED_VERIFIER: ${{ inputs.disable-delayed-verifier }}
        DISABLE_PERFORMANCE_VERIFIER: ${{ inputs.disable-performance-verifier }}
        DISABLE_RANDOM_VERIFIER: ${{ inputs.disable-random-verifier }}
        DISABLE_TELEGRAF: ${{ inputs.disable-telegraf }}
        ENVIRONMENT_TYPE: ${{ inputs.environment-type }}
        EVM_DATA_PAYMENTS_ADDRESS: ${{ inputs.evm-data-payments-address }}
        EVM_NETWORK_TYPE: ${{ inputs.evm-network-type }}
        EVM_PAYMENT_TOKEN_ADDRESS: ${{ inputs.evm-payment-token-address }}
        EVM_RPC_URL: ${{ inputs.evm-rpc-url }}
        FILE_ADDRESS: ${{ inputs.file-address }}
        NAME: ${{ inputs.name }}
        NETWORK_ID: ${{ inputs.network-id }}
        NETWORK_CONTACTS_URL: ${{ inputs.network-contacts-url }}
        PEER: ${{ inputs.peer }}
        PERFORMANCE_VERIFIER_BATCH_SIZE: ${{ inputs.performance-verifier-batch-size }}
        PROVIDER: ${{ inputs.provider }}
        RANDOM_VERIFIER_BATCH_SIZE: ${{ inputs.random-verifier-batch-size }}
        REGION: ${{ inputs.region }}
        REPO_OWNER: ${{ inputs.repo-owner }}
        SKIP_BINARY_BUILD: ${{ inputs.skip-binary-build }}
        SLEEP_DURATION: ${{ inputs.sleep-duration }}
      shell: bash
      run: |
        set -e

        cd sn-testnet-deploy
        command="testnet-deploy clients deploy-static-downloaders \
          --name $NAME \
          --network-id $NETWORK_ID \
          --environment-type $ENVIRONMENT_TYPE \
          --provider $PROVIDER "
        [[ $ANSIBLE_VERBOSE == "true" ]] && command="$command --ansible-verbose "
        [[ -n $ANSIBLE_FORKS ]] && command="$command --forks $ANSIBLE_FORKS "
        [[ -n $ANT_VERSION ]] && command="$command --ant-version $ANT_VERSION "
        [[ -n $BRANCH ]] && command="$command --branch $BRANCH "
        [[ -n $CHUNK_SIZE ]] && command="$command --chunk-size $CHUNK_SIZE "
        [[ -n $CLIENT_ENV ]] && command="$command --client-env $CLIENT_ENV "
        [[ -n $CLIENT_VM_COUNT ]] && command="$command --client-vm-count $CLIENT_VM_COUNT "
        [[ -n $CLIENT_VM_SIZE ]] && command="$command --client-vm-size $CLIENT_VM_SIZE "
        [[ -n $DELAYED_VERIFIER_BATCH_SIZE ]] && command="$command --delayed-verifier-batch-size $DELAYED_VERIFIER_BATCH_SIZE "
        [[ -n $DELAYED_VERIFIER_QUORUM_VALUE ]] && command="$command --delayed-verifier-quorum-value $DELAYED_VERIFIER_QUORUM_VALUE "
        [[ $DISABLE_DELAYED_VERIFIER == "true" ]] && command="$command --disable-delayed-verifier "
        [[ $DISABLE_PERFORMANCE_VERIFIER == "true" ]] && command="$command --disable-performance-verifier "
        [[ $DISABLE_RANDOM_VERIFIER == "true" ]] && command="$command --disable-random-verifier "
        [[ $DISABLE_TELEGRAF == "true" ]] && command="$command --disable-telegraf "
        [[ -n $EVM_DATA_PAYMENTS_ADDRESS ]] && command="$command --evm-data-payments-address $EVM_DATA_PAYMENTS_ADDRESS "
        [[ -n $EVM_NETWORK_TYPE ]] && command="$command --evm-network-type $EVM_NETWORK_TYPE "
        [[ -n $EVM_PAYMENT_TOKEN_ADDRESS ]] && command="$command --evm-payment-token-address $EVM_PAYMENT_TOKEN_ADDRESS "
        [[ -n $EVM_RPC_URL ]] && command="$command --evm-rpc-url \"$EVM_RPC_URL\" "
        [[ -n $FILE_ADDRESS ]] && command="$command --file-address $FILE_ADDRESS "
        [[ -n $NETWORK_CONTACTS_URL ]] && command="$command --network-contacts-url $NETWORK_CONTACTS_URL "
        [[ -n $PEER ]] && command="$command --peer $PEER "
        [[ -n $PERFORMANCE_VERIFIER_BATCH_SIZE ]] && command="$command --performance-verifier-batch-size $PERFORMANCE_VERIFIER_BATCH_SIZE "
        [[ -n $RANDOM_VERIFIER_BATCH_SIZE ]] && command="$command --random-verifier-batch-size $RANDOM_VERIFIER_BATCH_SIZE "
        [[ -n $REGION ]] && command="$command --region $REGION "
        [[ -n $REPO_OWNER ]] && command="$command --repo-owner $REPO_OWNER "
        [[ $SKIP_BINARY_BUILD == "true" ]] && command="$command --skip-binary-build "
        [[ -n $SLEEP_DURATION ]] && command="$command --sleep-duration $SLEEP_DURATION "

        echo "Will run testnet-deploy with: $command"
        eval $command
